# Phase 9.1: Combat Stats - Requirements Analysis

**Phase:** 9.1
**Component:** Combat System Foundation
**Dependencies:** Phase 8.3 (Basic AI), Entity System, Monster System
**Estimated Effort:** Medium (2-3 hours)

## Current State Analysis

### ‚úÖ Already Implemented

#### Player Combat Stats
- **HP System**: `hp` and `max_hp` with configuration support
- **Attack/Defense**: Basic stats with config integration
- **Damage Handling**: `takeDamage()` method with defense calculation
- **Death Detection**: `isDead()` method
- **Level/Experience**: Foundation for character progression

#### Monster Combat Stats
- **HP System**: `hp` and `max_hp` from JSON monster templates
- **Attack/Defense**: Combat stats loaded from data files
- **Damage Calculation**: `calculateDamage()` with randomization
- **Attack Rolls**: `getAttackRoll()` with d20 system
- **Defense Values**: `getDefenseValue()` for AC calculation
- **Damage Application**: `takeDamage()` with defense mitigation

#### Basic Combat Framework
- **Data Integration**: Monster stats from `data/monsters.json`
- **Configuration**: Player stats from `config.yml`
- **Random Number Generation**: Proper RNG for damage and rolls
- **Defense Mitigation**: Damage reduction based on defense values

### ‚ùå Missing Components

#### Centralized Combat System
- **No `CombatSystem` class**: Combat logic scattered across entities
- **No unified damage calculation**: Different formulas in different places
- **No combat event handling**: Direct damage application without events
- **No combat logging integration**: Limited combat message support

#### Advanced Combat Mechanics
- **No hit/miss system**: All attacks currently hit automatically
- **No critical hits**: No special damage calculations
- **No damage types**: Single damage type only
- **No status effects**: No buffs/debuffs framework
- **No weapon/armor modifiers**: Equipment not yet implemented

#### Integration Gaps
- **AI combat integration**: Partial - monsters can deal damage but limited
- **Turn system integration**: Combat happens but not properly sequenced
- **Message log integration**: Basic messages but not comprehensive
- **Save system preparation**: Combat state not serializable

## Phase 9.1 Requirements

### üéØ Primary Goals

#### 1. Create CombatSystem Class
```cpp
class CombatSystem {
public:
    struct CombatResult {
        bool hit = false;
        int damage = 0;
        bool critical = false;
        std::string message;
    };

    // Core combat methods
    CombatResult calculateAttack(const Entity& attacker, const Entity& defender);
    void applyDamage(Entity& target, int amount);
    bool isHit(int attack_roll, int defense_value);
    int calculateDamage(const Entity& attacker);

    // Combat event handling
    void processCombat(Entity& attacker, Entity& defender);
    std::vector<std::string> getCombatMessages() const;
};
```

#### 2. Standardize Damage Calculations
- **Unified Formula**: `max(1, (attack_roll + modifiers) - defense)`
- **Random Damage**: Consistent dice rolling across all entities
- **Defense Mitigation**: Standardized damage reduction
- **Minimum Damage**: Always deal at least 1 damage

#### 3. Improve Hit/Miss System
- **Attack Roll**: `1d20 + attack_bonus` vs `10 + defense + modifiers`
- **Critical Hits**: Natural 20 always hits, double damage
- **Critical Misses**: Natural 1 always misses
- **Attack Bonuses**: Include stats and equipment modifiers

#### 4. Combat Event System
- **Combat Messages**: Detailed attack/damage/miss descriptions
- **Combat Logging**: Integration with message log system
- **Event Callbacks**: Hooks for status effects and special abilities
- **Result Objects**: Structured combat outcome data

### üîß Technical Requirements

#### Entity Interface Updates
```cpp
// Add to Entity base class or combat interface
class ICombatant {
public:
    virtual int getAttackBonus() const = 0;
    virtual int getDefenseValue() const = 0;
    virtual int getAttackDamage() const = 0;
    virtual void onCombatHit(const CombatResult& result) = 0;
    virtual void onCombatMiss() = 0;
};
```

#### Combat Integration Points
- **GameManager**: Integrate combat system with game state
- **TurnManager**: Sequence combat actions properly
- **MessageLog**: Combat event messaging
- **AI System**: Enhanced combat decision making
- **EntityManager**: Combat entity tracking and cleanup

#### Configuration Support
```yaml
# config.yml additions
combat:
  base_hit_chance: 50      # Base percentage hit chance
  critical_hit_threshold: 20   # Die roll for critical hit
  critical_miss_threshold: 1   # Die roll for critical miss
  min_damage: 1            # Minimum damage dealt
  damage_variance: 0.2     # Randomness in damage (¬±20%)
```

### üìã Implementation Tasks

#### Core System Development
1. **Create CombatSystem class** with unified damage calculation
2. **Implement hit/miss mechanics** with proper attack rolls
3. **Add critical hit system** for enhanced combat depth
4. **Create combat result structures** for event data
5. **Integrate with message log** for combat feedback

#### Entity System Integration
6. **Update Entity base class** with combat interface methods
7. **Modify Player class** to use CombatSystem
8. **Update Monster class** to use CombatSystem
9. **Ensure stat compatibility** across all entities
10. **Add combat event callbacks** for future extensibility

#### Testing and Validation
11. **Create unit tests** for damage calculations
12. **Test hit/miss probability** distributions
13. **Validate critical hit mechanics**
14. **Test combat integration** with AI system
15. **Performance testing** with multiple combatants

### üéÆ Gameplay Requirements

#### Combat Balance
- **Player vs Monster**: Balanced encounters based on threat levels
- **Damage Scaling**: Appropriate damage ranges for different levels
- **Hit Rates**: Reasonable chance to hit/miss for tactical gameplay
- **Critical Impact**: Meaningful but not overwhelming critical hits

#### User Experience
- **Clear Feedback**: Informative combat messages
- **Visual Indicators**: Damage numbers and status updates
- **Responsive Feel**: Immediate combat resolution
- **Strategic Depth**: Meaningful choices in combat positioning

### üîó Integration with Existing Systems

#### AI System (Phase 8.3)
- **Combat Decisions**: AI can evaluate combat effectiveness
- **Flee Triggers**: Low health monsters can flee from combat
- **Aggression**: Combat stats influence AI behavior
- **Positioning**: AI considers combat range and damage

#### Monster System (Phase 8.1/8.2)
- **Stat Integration**: Use existing monster attack/defense values
- **JSON Compatibility**: Maintain current data format
- **Factory Integration**: CombatSystem works with MonsterFactory
- **Spawning**: Combat-ready monsters from spawn system

#### Turn System
- **Combat Timing**: Integrate with turn-based mechanics
- **Action Economy**: Combat actions consume turns appropriately
- **Initiative**: Speed stats influence turn order
- **Simultaneous Actions**: Handle multiple combatants properly

### üìä Success Metrics

#### Functional Requirements
- ‚úÖ All damage calculations use CombatSystem
- ‚úÖ Hit/miss mechanics work correctly
- ‚úÖ Critical hits occur at expected rates
- ‚úÖ Combat messages are informative and clear
- ‚úÖ AI system integrates with combat mechanics

#### Performance Requirements
- ‚úÖ Combat resolution < 1ms per attack
- ‚úÖ No memory leaks in combat processing
- ‚úÖ Handles 30+ monsters in combat simultaneously
- ‚úÖ Maintains 60 FPS during combat sequences

#### Quality Requirements
- ‚úÖ 100% test coverage for combat calculations
- ‚úÖ Combat system is deterministic for testing
- ‚úÖ Clean separation between combat logic and presentation
- ‚úÖ Extensible for future combat features

### üöÄ Future Considerations

#### Phase 9.2 Integration
- **Bump-to-Attack**: CombatSystem ready for collision detection
- **Combat UI**: Prepared for damage display and feedback
- **Animation Support**: Combat results support visual effects
- **Sound Integration**: Combat events can trigger audio

#### Advanced Features (Post-9.1)
- **Equipment Modifiers**: Framework ready for weapon/armor stats
- **Status Effects**: Combat result hooks for buffs/debuffs
- **Damage Types**: Extensible damage system (physical, magical, etc.)
- **Resistances**: Entity resistance/vulnerability system

## Dependencies and Prerequisites

### Required Before Starting
- ‚úÖ **Phase 8.3 Basic AI**: Monster intelligence for combat decisions
- ‚úÖ **Entity System**: Solid foundation for combat participants
- ‚úÖ **Monster System**: Combat stats and data loading
- ‚úÖ **Message Log**: Combat feedback mechanism

### Recommended Preparation
- **Review current damage calculations**: Understand existing formulas
- **Test current AI behavior**: Ensure monsters respond to damage
- **Validate entity stats**: Confirm all entities have required combat values
- **Check message log integration**: Ensure combat messages display properly

## Risk Assessment

### Low Risk
- **Existing Infrastructure**: Solid foundation already in place
- **Stat Systems**: Combat values already defined and working
- **AI Integration**: Recent AI system provides good integration points

### Medium Risk
- **Performance Impact**: New combat system could affect turn processing
- **Balance Changes**: Modified damage calculations may need rebalancing
- **Testing Complexity**: Combat interactions can be complex to validate

### Mitigation Strategies
- **Incremental Development**: Build and test each component separately
- **Performance Monitoring**: Track combat processing time during development
- **Balance Testing**: Use automated combat simulations for balance validation
- **Rollback Plan**: Maintain existing combat code until new system is proven

Phase 9.1 provides the foundation for all future combat enhancements while building on the solid systems already in place from previous phases.