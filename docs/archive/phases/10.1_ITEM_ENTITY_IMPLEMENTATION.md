# Phase 10.1: Item Entity Implementation

## Overview

This document details the complete implementation of the Item Entity system for Veyrm, adding collectible items, inventory management foundations, and item interactions to the game.

## Implementation Date

- **Started**: September 2024
- **Completed**: September 2024
- **Version**: 0.10.1

## Core Components Implemented

### 1. Item Class (`include/item.h`, `src/item.cpp`)

The base Item class represents all collectible objects in the game world.

#### Key Features

- **Properties**:
  - Position (x, y coordinates)
  - Identification (id, name, description)
  - Visual representation (symbol, color)
  - Item type enumeration
  - Value and weight for economy/encumbrance
  - Stackability support for items like gold and arrows
  - Generic properties map for flexible item effects

#### Item Types

```cpp
enum ItemType {
    POTION,
    SCROLL,
    WEAPON,
    ARMOR,
    FOOD,
    GOLD,
    MISC
};
```

### 2. ItemFactory Class (`include/item_factory.h`, `src/item_factory.cpp`)

Singleton factory pattern for creating items from data templates.

#### Key Features

- JSON-based item template loading
- Depth-based item availability
- Random item selection for dungeon generation
- Template validation and error handling
- Memory-efficient item creation

#### Template Structure

```cpp
struct ItemTemplate {
    std::string id;
    std::string name;
    std::string description;
    char symbol;
    std::string color;
    Item::ItemType type;
    int value;
    int weight;
    bool stackable;
    int max_stack;
    std::map<std::string, int> properties;
    int min_depth;
    int max_depth;
};
```

### 3. ItemManager Class (`include/item_manager.h`, `src/item_manager.cpp`)

Manages all items present on the game map.

#### Key Features

- Item spawning at specific locations
- Random item placement
- Item removal and cleanup
- Query items by position
- Gold pile generation with custom amounts
- Validation of spawn positions

#### Core Methods

- `spawnItem(item_id, x, y)` - Place specific item
- `spawnRandomItem(x, y, depth)` - Place depth-appropriate random item
- `removeItem(item)` - Remove item from world
- `getItemAt(x, y)` - Query item at position
- `spawnGold(x, y, amount)` - Create gold pile with amount

### 4. Item Data (`data/items.json`)

Comprehensive item database with 12 initial item types.

#### Items Implemented

1. **Potions** (2 types)
   - Minor Healing Potion (heal: 10 HP)
   - Major Healing Potion (heal: 25 HP)

2. **Scrolls** (3 types)
   - Scroll of Identify
   - Scroll of Teleportation
   - Scroll of Magic Mapping

3. **Food** (2 types)
   - Ration (nutrition: 500)
   - Apple (nutrition: 200)

4. **Gold** (1 type)
   - Gold Coins (stackable currency)

5. **Miscellaneous** (4 types)
   - Torch (light_radius: 3)
   - Rope (length: 50)
   - Lantern (light_radius: 5)
   - Key (generic)

## Game Integration

### 1. Rendering System Updates (`src/renderer.cpp`)

- Items now render between terrain and entities layers
- Color mapping from string names to FTXUI colors
- Visibility checks ensure items only show in FOV
- Memory system remembers item positions

### 2. Input System Updates (`src/input_handler.cpp`)

- Added GET_ITEM action (mapped to 'g' key)
- Integrated with existing input handling framework

### 3. Game Screen Integration (`src/game_screen.cpp`)

- Item pickup handling in game loop
- Gold automatically added to player inventory
- User feedback messages for pickup attempts
- Fast action speed for item collection

### 4. Game Manager Integration (`src/game_manager.cpp`)

- ItemFactory initialization on startup
- Item spawning during map generation
- 5-10 random items per level
- 3-6 gold piles per level
- Items spawn in walkable room tiles

### 5. Player Integration (`include/player.h`)

- Gold counter added to player stats
- Foundation for future inventory system

## Technical Improvements

### 1. Memory Management

- Used `std::unique_ptr` for item ownership
- Proper cleanup in ItemFactory singleton
- Clear ownership semantics in ItemManager

### 2. Const Correctness

- Added const overloads for query methods
- Proper const usage in rendering pipeline
- Immutable access for display systems

### 3. Error Handling

- Validation of spawn positions
- Graceful handling of missing item templates
- Logging for debugging and error tracking

### 4. Testing

- Comprehensive unit tests for all item systems
- 49 assertions across 4 test cases
- Tests run from project root for proper path resolution
- All tests passing

## Configuration Updates

### config.yml Integration

- Item data path configurable via `paths.data_dir`
- Tests properly load configuration
- Flexible deployment options

## Build System Updates

### CMakeLists.txt Changes

- Added item source files to main executable
- Added item source files to test executable
- Proper dependency ordering

### Test Infrastructure

- Tests run from project root via build.sh
- Proper path resolution for data files
- Integration with existing test suite

## API Examples

### Spawning Items

```cpp
// Spawn specific item
item_manager->spawnItem("potion_minor", x, y);

// Spawn random item for depth
item_manager->spawnRandomItem(x, y, current_depth);

// Spawn gold
item_manager->spawnGold(x, y, 50);
```

### Picking Up Items

```cpp
auto* item = item_manager->getItemAt(player->x, player->y);
if (item) {
    if (item->type == Item::ItemType::GOLD) {
        player->gold += item->properties["amount"];
    }
    item_manager->removeItem(item);
}
```

### Creating Items from Templates

```cpp
auto potion = ItemFactory::getInstance().create("potion_minor");
potion->setPosition(x, y);
```

## Future Enhancements

### Phase 10.2: Inventory System

- Player inventory container
- Inventory UI screen
- Item equipping/unequipping
- Item use actions

### Phase 10.3: Item Effects

- Potion healing implementation
- Scroll spell effects
- Food hunger system
- Equipment bonuses

### Phase 10.4: Item Generation

- Procedural item properties
- Magic item prefixes/suffixes
- Unique/artifact items
- Cursed items

## Testing Checklist

- [x] Items spawn on map generation
- [x] Items render with correct symbols and colors
- [x] Items only visible in FOV
- [x] Player can pick up items with 'g'
- [x] Gold adds to player gold counter
- [x] Multiple items can exist at same location
- [x] Items can be removed from world
- [x] Invalid spawn positions handled gracefully
- [x] All unit tests passing

## Performance Considerations

- Items stored in vector for O(n) position queries
- Consider spatial indexing for large item counts
- Rendering optimized to only check visible tiles
- Memory pooling could improve allocation performance

## Known Limitations

1. No actual inventory UI yet (items are picked up and destroyed)
2. Item effects not implemented (potions don't heal)
3. No item dropping mechanism
4. No item examination/description display
5. No weight/encumbrance system active

## Files Changed

- **New Files** (7):
  - `include/item.h`
  - `include/item_factory.h`
  - `include/item_manager.h`
  - `src/item.cpp`
  - `src/item_factory.cpp`
  - `src/item_manager.cpp`
  - `tests/test_item.cpp`

- **Modified Files** (11):
  - `CMakeLists.txt` - Added item source files
  - `data/items.json` - Populated with item definitions
  - `include/game_state.h` - Added ItemManager accessor
  - `include/input_handler.h` - Added GET_ITEM action
  - `include/renderer.h` - Updated rendering pipeline
  - `src/game_manager.cpp` - Integrated item spawning
  - `src/game_screen.cpp` - Added pickup handling
  - `src/input_handler.cpp` - Mapped 'g' key
  - `src/renderer.cpp` - Item rendering implementation
  - `tests/CMakeLists.txt` - Added item tests
  - `tests/test_input_handler.cpp` - Updated for GET_ITEM

## Dependencies

- nlohmann/json for data loading
- FTXUI for rendering
- Standard C++ library features (C++23)

## Code Metrics

- ~800 lines of new code
- 7 new classes/structures
- 49 test assertions
- 100% test coverage of public API

## Review Notes

The implementation follows SOLID principles with clear separation of concerns:

- Item: Single responsibility for item data
- ItemFactory: Open for extension via JSON
- ItemManager: Manages item lifecycle
- Clear interfaces between systems
- Dependency injection where appropriate
