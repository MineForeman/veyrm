# Phase 8.2: Monster Spawning

## Status: COMPLETE ✓

## Overview

Implemented a comprehensive monster spawning system that populates dungeons with monsters both at map generation and dynamically during gameplay. The system includes configurable spawn rates, room preference spawning (95% in rooms, 5% in corridors), and safety features to prevent spawning near the player.

## Implementation Summary

### Core Components

#### 1. SpawnManager Class (`include/spawn_manager.h`, `src/spawn_manager.cpp`)

- **Purpose**: Manages all monster spawning logic
- **Key Features**:
  - Initial monster spawning at map generation
  - Dynamic spawning during gameplay with turn-based timers
  - Room vs corridor spawn point separation
  - Depth-based monster selection with weighted probabilities
  - Configurable spawn parameters via config.yml

#### 2. Monster Data Updates (`data/monsters.json`)

Added spawn metadata to all 5 base monsters:

- `spawn_weight`: Probability weight for selection
- `min_depth`: Minimum dungeon level for spawning
- `max_depth`: Maximum dungeon level for spawning  
- `pack_size`: Array defining min/max group size (for future pack spawning)

Example:

```json
{
  "species": "gutter_rat",
  "spawn_weight": 1.0,
  "min_depth": 1,
  "max_depth": 5,
  "pack_size": [2, 4]
}
```

#### 3. Configuration System (`config.yml`)

Added comprehensive spawn configuration:

```yaml
monsters:
  initial_monster_count: 10    # Monsters spawned at map generation
  max_per_level: 30            # Maximum monsters allowed on level
  spawn_rate: 100              # Turns between spawn attempts
  spawn_outside_fov: true      # Only spawn where player can't see
  min_spawn_distance: 5        # Minimum tiles from player
  room_spawn_percentage: 0.95  # 95% of monsters spawn in rooms
```

### Key Algorithms

#### Room Preference Spawning

- Separates spawn points into room points and corridor points
- Distributes monsters based on `room_spawn_percentage` (default 95%)
- Fallback logic if insufficient spawn points of preferred type

#### Spawn Point Validation

- Must be walkable tile
- Must not be special tile (stairs)
- Must be minimum distance from player
- Must be outside player's FOV (if configured)

#### Depth-Based Selection

- Weighted random selection based on dungeon depth
- Each monster species has min/max depth range
- Spawn weights affect probability of selection

### Integration Points

#### GameManager Integration

- Creates SpawnManager instance on initialization
- Loads monster data from JSON on startup
- Calls initial spawning after player placement
- Updates spawn manager each turn for dynamic spawning

#### Entity System Integration

- Monsters created through EntityManager
- Visibility updated based on FOV calculations
- Proper entity lifecycle management

#### Renderer Integration

- Fixed monster rendering in MapRenderer
- Monsters now properly display when visible
- Correct glyph and color rendering

### Testing

Comprehensive test suite in `tests/test_spawn_manager.cpp`:

- Spawn point validation tests
- Initial spawning tests
- Dynamic spawning tests
- Room preference spawning verification
- Max monster limit enforcement
- Species selection by depth

## Files Changed

### New Files

- `include/spawn_manager.h` - SpawnManager class header
- `src/spawn_manager.cpp` - SpawnManager implementation
- `tests/test_spawn_manager.cpp` - Comprehensive test suite
- `DOC/PHASES/8.2_MONSTER_SPAWNING.md` - This documentation

### Modified Files

- `CMakeLists.txt` - Added spawn_manager.cpp to build
- `tests/CMakeLists.txt` - Added test_spawn_manager.cpp
- `include/game_state.h` - Added SpawnManager and depth tracking
- `src/game_manager.cpp` - Integrated spawn system
- `include/config.h` - Added spawn configuration getters
- `src/config.cpp` - Added spawn configuration parsing
- `config.yml` - Added spawn configuration section
- `data/monsters.json` - Added spawn metadata to monsters
- `src/monster.cpp` - Fixed visibility initialization
- `src/renderer.cpp` - Fixed monster rendering
- `build.sh` - Added support for "procedural" map type

## Configuration Options

| Setting | Default | Description |
|---------|---------|-------------|
| `initial_monster_count` | 10 | Number of monsters spawned at map generation |
| `max_per_level` | 30 | Maximum monsters allowed on a level |
| `spawn_rate` | 100 | Turns between spawn attempts |
| `spawn_outside_fov` | true | Only spawn where player can't see |
| `min_spawn_distance` | 5 | Minimum tiles from player for spawning |
| `room_spawn_percentage` | 0.95 | Percentage of monsters that spawn in rooms |

## Monster Spawn Table

| Monster | Min Depth | Max Depth | Weight | Threat |
|---------|-----------|-----------|--------|--------|
| Gutter Rat | 1 | 5 | 1.0 | 1 |
| Cave Spider | 1 | 10 | 0.8 | 2 |
| Kobold | 2 | 15 | 0.7 | 2 |
| Orc Rookling | 3 | 20 | 0.6 | 3 |
| Zombie | 5 | 30 | 0.5 | 4 |

## Known Issues

- FOV-based spawn prevention uses simple distance check (should use actual FOV calculation)
- Pack spawning metadata defined but not yet implemented
- Threat budget system defined but not enforced

## Future Enhancements

- Implement pack spawning for group monsters
- Add threat budget enforcement for difficulty scaling
- Use actual FOV calculation for spawn point validation
- Add spawn animations/effects
- Implement unique/boss monster spawning
- Add spawn pools for themed areas

## Testing Results

All spawn-related tests passing:

- 5 test cases with 314 assertions
- Room preference spawning verified (≥75% in rooms)
- Dynamic spawning functional
- Max monster limits enforced
